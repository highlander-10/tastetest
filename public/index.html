<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taste Test Challenge!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="themeStyle">
        :root {
            --primary-color: #4F46E5; /* Indigo */
            --secondary-color: #EC4899; /* Pink */
            --background-color: #F3F4F6; /* Gray 100 */
            --text-color: #1F2937; /* Gray 800 */
            --card-background-color: #FFFFFF;
            --font-family: 'Inter', sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .themed-background { background-color: var(--background-color); }
        .themed-text { color: var(--text-color); }
        .themed-primary-text { color: var(--primary-color); }
        /* ... other theme classes ... */
        .themed-button { background-color: var(--primary-color); color: white; }
        .themed-button:hover { filter: brightness(110%); }
        .themed-input { border-color: var(--primary-color); }
        .themed-input:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 2px var(--secondary-color); }
        input[type="radio"].themed-primary-text { color: var(--primary-color); }
        input[type="radio"].themed-primary-text:focus { ring-color: var(--secondary-color); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 themed-background transition-colors duration-500">

    <div id="loadingIndicator" class="fixed inset-0 bg-slate-500 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
        <p class="ml-4 text-white text-xl">Loading...</p>
    </div>

    <!-- Participant Name Selection Section -->
    <div id="participantSelectionSection" class="w-full max-w-md text-center">
        <div class="themed-card-bg shadow-xl rounded-lg p-6 md:p-10">
            <header class="mb-6">
                <h1 id="participantWelcomeTitle" class="text-3xl md:text-4xl font-bold themed-primary-text">Welcome Taster!</h1>
            </header>
            <p id="participantEventInfo" class="text-md themed-text mb-4">Loading event details...</p>
            <div class="mb-6">
                <label for="participantNameSelect" class="block text-sm font-medium themed-text mb-1">Select Your Name:</label>
                <select id="participantNameSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-secondary-color focus:border-secondary-color sm:text-sm rounded-md themed-input themed-card-bg themed-text">
                    <option value="">-- Please Select --</option>
                    <!-- Names will be populated by JS or hardcoded for now -->
                </select>
            </div>
            <button id="startTastingButton" class="themed-button font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-opacity-75 hidden">
                Start Tasting!
            </button>
            <div id="noActiveEventForParticipantMessage" class="hidden mt-4 p-3 bg-yellow-100 text-yellow-700 rounded-md">
                <p>No active tasting event found. Please check with the admin.</p>
            </div>
        </div>
    </div>

    <!-- Taste Test Form Section (Initially Hidden) -->
    <div id="tasteTestSection" class="w-full max-w-2xl hidden">
        <div id="appContainer">
            <div class="themed-card-bg shadow-xl rounded-lg p-6 md:p-10">
                <header class="mb-6 text-center">
                    <h1 id="testTitle" class="text-2xl md:text-3xl font-bold themed-primary-text">Rate This Item</h1>
                    <p id="testLocationAndItemInfo" class="text-lg themed-secondary-text"></p>
                    <p id="ratingScaleExplanation" class="text-xs themed-text mt-2 p-2 bg-slate-100 rounded-md"></p>
                </header>
                <div id="messageArea" class="hidden p-3 rounded-md text-sm mb-6"></div>
                <form id="submissionForm">
                    <div id="formContainer" class="space-y-6">
                        <!-- Questions will be rendered here -->
                    </div>
                    <div class="mt-10 text-center">
                        <button type="submit" id="submitButton" class="themed-button font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-opacity-75 hidden">
                            Submit Feedback
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="text-center mt-8 fixed bottom-4 w-full">
        <p class="text-sm themed-text opacity-70">Taste Testing App</p>
    </footer>

    <script type="module">
        // UI Elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const participantSelectionSection = document.getElementById('participantSelectionSection');
        const participantWelcomeTitle = document.getElementById('participantWelcomeTitle');
        const participantEventInfo = document.getElementById('participantEventInfo');
        const participantNameSelect = document.getElementById('participantNameSelect');
        const startTastingButton = document.getElementById('startTastingButton');
        const noActiveEventForParticipantMessage = document.getElementById('noActiveEventForParticipantMessage');
        
        const tasteTestSection = document.getElementById('tasteTestSection');
        const testTitleElement = document.getElementById('testTitle');
        const testLocationAndItemInfo = document.getElementById('testLocationAndItemInfo');
        const ratingScaleExplanationText = document.getElementById('ratingScaleExplanation');
        const formContainer = document.getElementById('formContainer');
        const submissionForm = document.getElementById('submissionForm');
        const submitButton = document.getElementById('submitButton');
        const messageArea = document.getElementById('messageArea');

        let fullEventConfig = null; 
        let selectedParticipantName = "";
        let currentItemForTasting = null; // To store the specific item object being tasted

        // --- Participant Names (Hardcoded for now, admin will manage later) ---
        const participantNames = ["Phill", "Player 2", "Player 3", "Player 4"]; // Admin will define these per event eventually

        // API Endpoints
        const API_BASE_URL = '/api';
        const GET_ACTIVE_EVENT_CONFIG_ENDPOINT = `${API_BASE_URL}/get-active-event-config`;
        const SUBMIT_FEEDBACK_ENDPOINT = `${API_BASE_URL}/submit-feedback`;

        function populateParticipantNames() {
            participantNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                participantNameSelect.appendChild(option);
            });
        }

        async function initializeParticipantWelcome() {
            showLoading(true);
            populateParticipantNames();
            try {
                const response = await fetch(GET_ACTIVE_EVENT_CONFIG_ENDPOINT);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "Failed to load event configuration." }));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (data && data.config && data.config.eventId && data.config.activeLocation) {
                    fullEventConfig = data.config;
                    participantWelcomeTitle.textContent = `Welcome to ${fullEventConfig.eventName || "the Taste Test"}!`;
                    participantEventInfo.textContent = `We're currently at: ${fullEventConfig.activeLocation.locationName}.`;
                    applyTheme(fullEventConfig.testTypeConfig?.theme);
                    startTastingButton.classList.remove('hidden');
                    noActiveEventForParticipantMessage.classList.add('hidden');
                } else {
                    participantEventInfo.textContent = data.message || "No active event is currently configured.";
                    startTastingButton.classList.add('hidden');
                    noActiveEventForParticipantMessage.classList.remove('hidden');
                    noActiveEventForParticipantMessage.textContent = data.message || "No active event is currently configured.";
                    applyTheme(null);
                }
            } catch (error) {
                console.error("Initialization error:", error);
                participantEventInfo.textContent = "Error loading event details.";
                noActiveEventForParticipantMessage.classList.remove('hidden');
                noActiveEventForParticipantMessage.textContent = "An error occurred fetching event details.";
                applyTheme(null);
            } finally {
                showLoading(false);
            }
        }

        participantNameSelect.addEventListener('change', (event) => {
            selectedParticipantName = event.target.value;
            if (selectedParticipantName && fullEventConfig) { // Only show button if an event is loaded
                startTastingButton.disabled = false;
            } else {
                startTastingButton.disabled = true;
            }
        });
        startTastingButton.addEventListener('click', () => {
            if (!selectedParticipantName) {
                alert("Please select your name first!"); // Replace with better modal later
                return;
            }
            if (!fullEventConfig || !fullEventConfig.activeLocation || !fullEventConfig.activeLocation.items || fullEventConfig.activeLocation.items.length === 0) {
                alert("No items available for tasting at this location. Please check with the admin.");
                return;
            }
            participantSelectionSection.classList.add('hidden');
            tasteTestSection.classList.remove('hidden');
            // For now, let's assume we taste the FIRST item at the active location.
            // Later, admin might set a specific item, or user might select from multiple.
            currentItemForTasting = fullEventConfig.activeLocation.items[0]; 
            if (fullEventConfig.activeLocation.items.length > 1) {
                // If multiple items, we'd need an item selection step here.
                // For now, defaulting to first. This is a simplification.
                console.warn("Multiple items available, defaulting to the first:", currentItemForTasting.itemName);
            }
             if (!currentItemForTasting) {
                alert("Error: Could not determine the item to taste.");
                participantSelectionSection.classList.remove('hidden');
                tasteTestSection.classList.add('hidden');
                return;
            }

            loadAndDisplayTestForm();
        });


        function loadAndDisplayTestForm() {
            testTitleElement.textContent = fullEventConfig.testTypeConfig.displayName || "Rate This Item";
            testLocationAndItemInfo.textContent = `Location: ${fullEventConfig.activeLocation.locationName} | Item: ${currentItemForTasting.itemName}`;
            ratingScaleExplanationText.textContent = fullEventConfig.testTypeConfig.ratingScaleExplanation || "Rate 0-5 based on your preference.";
            renderQuestions();
        }
        
        function applyTheme(themeConfig) {
            const defaultTheme = { /* ... as before ... */ };
            const themeToApply = themeConfig ? { ...defaultTheme, ...themeConfig } : defaultTheme;
            document.documentElement.style.setProperty('--primary-color', themeToApply.primaryColor);
            // ... rest of theme application ...
        }

        function renderQuestions() {
            if (!fullEventConfig || !fullEventConfig.testTypeConfig || !fullEventConfig.testTypeConfig.questions) {
                formContainer.innerHTML = '<p class="text-center themed-text">No questions found for this taste test type.</p>';
                submitButton.classList.add('hidden');
                return;
            }
            formContainer.innerHTML = '';
            const questions = fullEventConfig.testTypeConfig.questions;

            questions.forEach(q => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'mb-6';
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium themed-text mb-1';
                label.htmlFor = q.id;
                label.textContent = q.text + (q.required ? ' *' : '');
                questionDiv.appendChild(label);

                if (q.type === 'rating_0_5') {
                    const ratingContainer = document.createElement('div');
                    ratingContainer.className = 'flex space-x-1 sm:space-x-2 mt-2 flex-wrap justify-center';
                    for (let i = 0; i <= 5; i++) {
                        const radioDiv = document.createElement('div');
                        radioDiv.className = 'flex flex-col items-center'; // Stack radio and label
                        const radio = document.createElement('input');
                        radio.type = 'radio'; radio.id = `${q.id}_${i}`; radio.name = q.id; radio.value = i;
                        radio.className = 'h-5 w-5 themed-primary-text focus:ring-secondary-color border-gray-300 mb-1';
                        if (q.required) radio.required = true;
                        
                        const radioLabel = document.createElement('label');
                        radioLabel.htmlFor = `${q.id}_${i}`; radioLabel.textContent = i;
                        radioLabel.className = 'text-xs themed-text';
                        
                        radioDiv.appendChild(radio); 
                        radioDiv.appendChild(radioLabel);
                        ratingContainer.appendChild(radioDiv);
                    }
                    questionDiv.appendChild(ratingContainer);
                } else if (q.type === 'text_long') { // Comments
                    const textarea = document.createElement('textarea');
                    textarea.id = q.id; textarea.name = q.id; textarea.rows = 4;
                    textarea.className = 'mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none sm:text-sm themed-input themed-card-bg themed-text';
                    if (q.required) textarea.required = true;
                    questionDiv.appendChild(textarea);
                }
                // Add other question types if needed in the future
                formContainer.appendChild(questionDiv);
            });
            submitButton.classList.remove('hidden');
        }

        submissionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!fullEventConfig || !fullEventConfig.testTypeConfig || !currentItemForTasting || !selectedParticipantName) {
                displayMessage("Cannot submit: Configuration or selection error.", "error", messageArea); return;
            }
            showLoading(true);
            submitButton.disabled = true;
            const formData = new FormData(submissionForm);
            const answers = {};
            let allRequiredFilled = true;
            let firstMissingFieldLabel = "";

            fullEventConfig.testTypeConfig.questions.forEach(q => {
                const value = formData.get(q.id);
                answers[q.id] = value;
                if (q.required && (value === null || String(value).trim() === "")) {
                    allRequiredFilled = false;
                    if (!firstMissingFieldLabel) firstMissingFieldLabel = q.text;
                }
            });

            if (!allRequiredFilled) {
                displayMessage(`Please fill out all required rating fields. '${firstMissingFieldLabel}' is missing.`, "error", messageArea);
                showLoading(false); submitButton.disabled = false; return;
            }

            const submissionData = {
                eventId: fullEventConfig.eventId,
                locationId: fullEventConfig.activeLocation.locationId,
                itemId: currentItemForTasting.itemId, // Using the specific item ID
                itemName: currentItemForTasting.itemName, // Using the specific item name
                participantName: selectedParticipantName,
                testTypeId: fullEventConfig.testTypeConfig.id,
                answers: answers,
                submittedAt: new Date().toISOString()
            };

            try {
                const response = await fetch(SUBMIT_FEEDBACK_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData),
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "Failed to submit feedback." }));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }
                const result = await response.json();
                displayMessage(result.message || "Thank you! Your feedback has been submitted.", "success", messageArea);
                submissionForm.reset();
                // After submission, go back to participant selection or a "thank you" screen
                tasteTestSection.classList.add('hidden');
                participantSelectionSection.classList.remove('hidden');
                participantNameSelect.value = ""; // Reset name selection
                startTastingButton.disabled = true;
                // initializeParticipantWelcome(); // Could re-fetch if event details might change rapidly
            } catch (error) {
                console.error("Error submitting feedback:", error);
                displayMessage(`Error submitting feedback: ${error.message}`, "error", messageArea);
            } finally {
                showLoading(false); submitButton.disabled = false;
            }
        });

        function showLoading(isLoading) { /* ... as before ... */ }
        function displayMessage(message, type = "info", targetElement = messageArea) { /* ... as before ... */ }
        
        initializeParticipantWelcome(); // Start with the participant welcome/selection screen
    </script>
</body>
</html>
