<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Margarita Taste Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overscroll-behavior-y: contain;
        }
        .hidden { display: none; }
        .rating-explanation {
            font-size: 0.85rem;
            color: #6B7280; /* Tailwind gray-500 */
            margin-top: 4px;
            margin-bottom: 8px;
            padding: 8px;
            background-color: #F3F4F6; /* Tailwind gray-100 */
            border-left: 4px solid #60A5FA; /* Tailwind blue-400 */
            border-radius: 4px;
        }
        /* Style for versioning text */
        .app-version {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        /* Style for trivia/jokes */
        .trivia-joke {
            font-size: 0.9rem;
            color: #4A5568; /* Tailwind gray-700 */
            background-color: #EDF2F7; /* Tailwind gray-200 */
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }

        /* Styling for taste-test-section background and colors */
        #taste-test-section {
            background-color: #f7fafc; /* Light gray */
            background-image: url('https://placehold.co/600x400/D1FAE5/000000?text=Margarita+Background'); /* Subtle light green wave */
            background-size: cover;
            background-position: center bottom;
            background-repeat: no-repeat;
            min-height: calc(100vh - 80px); /* Adjust for header */
            padding-bottom: 30px; /* Space for content above footer */
        }
        #taste-test-section h2, #taste-test-section h3 {
            color: #10B981; /* Emerald green */
        }
        #taste-test-section .bg-gray-50 {
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent white for cards */
        }
        #taste-test-section button.bg-blue-500 {
            background-color: #3B82F6; /* Brighter blue */
        }
        #taste-test-section button.bg-blue-500:hover {
            background-color: #2563EB; /* Darker blue */
        }
        #taste-test-section button.bg-green-600 {
            background-color: #059669; /* Darker green */
        }
        #taste-test-section button.bg-green-600:hover {
            background-color: #047857; /* Even darker green */
        }
        /* Styling for the item selection radio buttons */
        .item-radio-group label {
            display: block;
            background-color: #E0F2F7; /* Light blue background */
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-bottom: 8px;
            border: 2px solid #BFDBFE; /* Light blue border */
        }
        .item-radio-group label:hover {
            background-color: #DBEEF4;
            border-color: #93C5FD;
        }
        .item-radio-group input[type="radio"] {
            margin-right: 8px;
        }
        .item-radio-group input[type="radio"]:checked + span {
            font-weight: bold;
            color: #1D4ED8; /* Darker blue text */
        }
        .item-radio-group input[type="radio"]:checked + span::before {
            content: "âœ… "; /* Checkmark emoji */
        }

        /* Styling for dynamically loaded images */
        .dynamic-image-container {
            width: 100%;
            max-width: 300px; /* Limit max width */
            height: 200px; /* Fixed height for consistency */
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 15px;
            overflow: hidden; /* Hide parts of image if it's too big */
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; /* For centering image within container */
            align-items: center;
            justify-content: center;
        }
        .dynamic-image-container img {
            width: auto; /* Allow natural width */
            height: 100%; /* Fill height of container */
            max-width: 100%; /* Ensure it doesn't overflow */
            object-fit: contain; /* Ensure entire image is visible, scale down if too big */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-md mx-auto bg-white min-h-screen shadow-md">
        <header id="app-header" class="bg-green-500 text-white p-4 text-center sticky top-0 z-50 shadow">
            <h1 id="header-title" class="text-xl font-bold">Margarita Taste Test</h1>
            <p id="header-session-info" class="text-xs"></p>
            <p id="app-version-display" class="app-version"></p>
        </header>

        <main class="p-4 space-y-6">
            <div id="loading-screen" class="text-center p-8">
                <p class="text-lg text-gray-700 mb-4">Loading application...</p>
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                <div class="dynamic-image-container"><img id="loading-image" src="" alt="Margarita Loading"></div>
                <div class="trivia-joke" id="loading-trivia-joke"></div>
            </div>

            <div id="welcome-screen" class="hidden">
                <div class="dynamic-image-container"><img id="welcome-image" src="" alt="Margarita Welcome"></div>
                
                <button id="phill-starts-session-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg mb-4 transition duration-150 shadow-sm">
                    Phill Starts Session (Admin)
                </button>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h2 class="text-lg font-semibold mb-3 text-center text-blue-600">Player: Join Existing Test</h2>
                    <input type="text" id="player-name-input" placeholder="Your Name" class="w-full p-3 border border-gray-300 rounded-lg mb-3 text-base focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    <input type="text" id="session-id-input" placeholder="Enter Session ID" class="w-full p-3 border border-gray-300 rounded-lg mb-3 text-base focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    <button id="start-test-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-150 shadow-sm">
                        Join Test Manually
                    </button>
                </div>
                 <div class="trivia-joke" id="welcome-trivia-joke"></div>
            </div>

            <div id="admin-panel-screen" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-green-700">Admin Panel</h2>
                <p class="mb-2 text-sm">Session ID: <strong id="admin-session-id-display" class="text-purple-600 break-all"></strong> 
                   <button id="admin-copy-session-id-btn" class="ml-2 text-xs bg-gray-200 hover:bg-gray-300 p-1 rounded">Copy ID</button>
                </p>

                <div class="my-6 p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                    <h3 class="text-xl font-semibold mb-3 text-green-600">Manage Locations</h3>
                    <input type="text" id="new-location-admin-input" placeholder="New Location Name (e.g., The Tequila Bar)" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-green-500 focus:border-green-500 shadow-sm">
                    <button id="add-location-from-admin-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-sm">
                        Add New Location
                    </button>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold mb-2">Existing Locations:</h4>
                        <ul id="admin-locations-list" class="space-y-2">
                            </ul>
                    </div>
                </div>

                <div class="my-6 p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                    <h3 class="text-xl font-semibold mb-3 text-blue-600">Share with Participants</h3>
                    <input type="text" id="participant-name-share-input" placeholder="Participant's Name" class="w-full p-3 border border-gray-300 rounded-lg mb-3 text-base focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    <button id="generate-share-link-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-sm">
                        Generate Share Link
                    </button>
                    <div class="mt-4 break-words text-sm text-gray-700">
                        Share this link: <a href="#" id="generated-share-link" class="text-blue-500 hover:underline"></a>
                        <button id="copy-share-link-btn" class="ml-2 text-xs bg-gray-200 hover:bg-gray-300 p-1 rounded hidden">Copy Link</button>
                    </div>
                </div>

                <div class="flex flex-col space-y-3 mt-6">
                    <button id="admin-view-tasting-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition duration-150">
                        View Tasting Interface (as Admin)
                    </button>
                    <button id="admin-view-results-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm transition duration-150">
                        View Current Results
                    </button>
                    <button id="admin-end-session-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg mt-6 shadow-sm transition duration-150">
                        End Admin Session (Back to Welcome)
                    </button>
                </div>
            </div>


            <div id="taste-test-section" class="hidden p-4 space-y-6">
                <h2 class="text-2xl font-bold mb-4" id="test-event-name"></h2>
                <p class="text-sm text-gray-600 mb-4">You are: <strong id="current-player-name"></strong></p>
                <div class="my-6 p-4 border rounded-lg bg-gray-50 shadow-sm">
                    <h3 class="text-xl font-semibold mb-3">Current Location:</h3>
                    <select id="location-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm mb-3"></select>
                    <button id="refresh-locations-btn" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-sm text-sm mt-2">Refresh Locations</button>
                </div>

                <form id="rating-form">
                    <div id="item-radio-group" class="mb-6 p-4 border rounded-lg bg-gray-50 shadow-sm hidden">
                         <h3 class="text-xl font-semibold mb-3">Which Margarita are you tasting here?</h3>
                         </div>

                    <p class="mb-4 text-gray-600 italic">Rate each aspect based on how well it matches your ideal margarita. 5 is perfect for you, 0 is the complete opposite of what you prefer.</p>

                    <div class="rating-explanation"></div>
                    <div id="question-fields" class="space-y-4">
                        </div>
                    <div class="mt-6">
                        <label for="comments" class="block text-gray-700 font-medium mb-1">Additional Comments:</label>
                        <textarea id="comments" name="comments" rows="3" placeholder="Any other thoughts?" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg mt-6 transition duration-150 shadow-sm">
                        Submit Feedback
                    </button>
                </form>

                <button id="view-results-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg my-6 transition duration-150 shadow-sm">
                    View Current Results
                </button>
                 <button id="leave-session-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg mt-2 transition duration-150 shadow-sm">
                    Leave Session
                </button>
                 <div class="trivia-joke" id="tasting-trivia-joke"></div>
            </div>

            <div id="results-screen" class="hidden">
                <h1 class="text-2xl font-bold mb-4 text-yellow-700">Session Results</h1>
                <p class="mb-4 text-xs">Session ID: <strong id="results-session-id"></strong></p>
                <div class="dynamic-image-container"><img id="results-image" src="" alt="Margarita Results"></div>
                <div id="results-summary" class="space-y-4"></div>
                <button id="view-winner-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg my-6 transition duration-150 shadow-sm">
                    See Winning Item!
                </button>
                <button id="back-to-tasting-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg mt-2 transition duration-150 shadow-sm">
                    Back to Tasting
                </button>
            </div>

            <div id="winner-screen" class="hidden text-center">
                <h1 class="text-3xl font-bold mb-6 text-red-500">ðŸŽ‰ And the Winner Is... ðŸŽ‰</h1>
                <div id="winning-item-details" class="p-6 bg-yellow-100 border-2 border-yellow-400 rounded-lg shadow-lg">
                </div>
               <div class="dynamic-image-container"><img id="winner-image" src="" alt="Margarita Winner"></div>
                <button id="winner-back-to-results-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mt-6 transition duration-150 shadow-sm">
                    Back to Results
                </button>
                 <button id="winner-new-session-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg mt-2 transition duration-150 shadow-sm">
                    Start New Session
                </button>
            </div>
        </main>

        <div id="alert-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center p-4 z-[2000]">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
                <h3 id="alert-title" class="text-lg font-semibold leading-6 text-gray-900 mb-2">Alert</h3>
                <div class="mt-2">
                    <p id="alert-message" class="text-sm text-gray-700"></p>
                </div>
                <div class="mt-5 sm:mt-6">
                    <button id="alert-ok-btn" type="button" class="w-full inline-flex justify-center rounded-lg border border-transparent bg-blue-500 px-4 py-2 text-base font-medium text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-sm">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    const APP_PREFIX = 'margaritaTestApp_';
    const APP_VERSION = '1.0'; 
    const ADMIN_PIN = '1234'; // **CHANGE THIS FOR PRODUCTION!**
    const MAX_RATING = 5;
    const RATING_EXPLANATION = "For all ratings (0-5 or sliders): Think about your ideal margarita. A rating of 5 means this aspect (e.g., sweetness, spiciness) is PERFECTLY what you like. A 0 means it's the complete opposite of what you prefer. Use the in-between values to show how close or far it is from your ideal.";
    const PHILL_ADMIN_ID = 'phill_the_admin'; 

    const MARGARITA_IMAGES = [
        "https://ih1.redbubble.net/image.4131737203.9681/poster,504x498,f8f8f8-pad,600x600,f8f8f8.jpg",
        "https://www.digitalmomblog.com/wp-content/uploads/2022/02/Thinking-about-a-margarita-720x720.jpg",
        "https://i.pinimg.com/736x/03/98/30/039830e0f44ce625f3f9429bf674497f.jpg",
        "https://images.squarespace-cdn.com/content/v1/5143771ae4b04eaef3677f95/1564611102018-5RNMUU42CGNA296CNX26/public.jpeg",
        "https://res.cloudinary.com/dukq9ubgm/images/f_auto,q_auto/v1739588799/Keep-calm-meme-margarita/Keep-calm-meme-margarita.jpg?_i=AA",
        "https://imgix.bustle.com/2017/2/17/9286d94f-ddf9-413f-ae0e-aaf2d001589b.png?w=760&h=758&fit=crop&crop=faces&auto=format%2Ccompress&q=50&dpr=2",
        "https://i5.walmartimages.com/seo/Stupell-Industries-Funny-Margarita-Phrase-Food-Beverage-Painting-Black-Floater-Framed-Canvas-Art-Print-Wall-Art-18-x-18_212d0c0a-b339-4365-ac2c-0a991630bad1.db904e123a763ad3ca51b0a95787da57.jpeg"
    ];
    let currentImageIndex = 0; 

    // DOM Elements
    const loadingScreen = document.getElementById('loading-screen');
    const welcomeScreen = document.getElementById('welcome-screen');
    const tasteTestSection = document.getElementById('taste-test-section');
    const resultsScreen = document.getElementById('results-screen');
    const winnerScreen = document.getElementById('winner-screen');
    const adminPanelScreen = document.getElementById('admin-panel-screen'); 
    const screens = [loadingScreen, welcomeScreen, tasteTestSection, resultsScreen, winnerScreen, adminPanelScreen];

    const appHeader = document.getElementById('app-header');
    const headerTitle = document.getElementById('header-title');
    const headerSessionInfo = document.getElementById('header-session-info');
    const appVersionDisplay = document.getElementById('app-version-display'); 

    const playerNameInput = document.getElementById('player-name-input');
    const sessionIdInput = document.getElementById('session-id-input');
    const startTestBtn = document.getElementById('start-test-btn'); 
    const phillStartsSessionBtn = document.getElementById('phill-starts-session-btn'); 

    // ADMIN PANEL ELEMENTS
    const adminSessionIdDisplay = document.getElementById('admin-session-id-display');
    const adminCopySessionIdBtn = document.getElementById('admin-copy-session-id-btn');
    const newLocationAdminInput = document.getElementById('new-location-admin-input');
    const addLocationFromAdminBtn = document.getElementById('add-location-from-admin-btn');
    const adminLocationsList = document.getElementById('admin-locations-list');
    const participantNameShareInput = document.getElementById('participant-name-share-input');
    const generateShareLinkBtn = document.getElementById('generate-share-link-btn');
    const generatedShareLink = document.getElementById('generated-share-link');
    const copyShareLinkBtn = document.getElementById('copy-share-link-btn');
    const adminViewTastingBtn = document.getElementById('admin-view-tasting-btn');
    const adminViewResultsBtn = document.getElementById('admin-view-results-btn');
    const adminEndSessionBtn = document.getElementById('admin-end-session-btn');

    // TASTE TEST SECTION ELEMENTS
    const testEventNameDisplay = document.getElementById('test-event-name');
    const currentPlayerNameDisplay = document.getElementById('current-player-name');

    const locationSelect = document.getElementById('location-select');
    const itemRadioGroup = document.getElementById('item-radio-group'); 
    const ratingForm = document.getElementById('rating-form');
    const questionFields = document.getElementById('question-fields');
    const commentsTextarea = document.getElementById('comments');
    const viewResultsBtn = document.getElementById('view-results-btn');
    const leaveSessionBtn = document.getElementById('leave-session-btn');
    const refreshLocationsBtn = document.getElementById('refresh-locations-btn'); 

    const resultsSessionIdDisplay = document.getElementById('results-session-id');
    const resultsSummary = document.getElementById('results-summary');
    const viewWinnerBtn = document.getElementById('view-winner-btn');
    const backToTastingBtn = document.getElementById('back-to-tasting-btn');

    const winningItemDetails = document.getElementById('winning-item-details');
    const winnerBackToResultsBtn = document.getElementById('winner-back-to-results-btn');
    const winnerNewSessionBtn = document.getElementById('winner-new-session-btn');

    const alertModal = document.getElementById('alert-modal');
    const alertTitle = document.getElementById('alert-title');
    const alertMessage = document.getElementById('alert-message');
    const alertOkBtn = document.getElementById('alert-ok-btn');

    const loadingTriviaJokeDisplay = document.getElementById('loading-trivia-joke'); 
    const welcomeTriviaJokeDisplay = document.getElementById('welcome-trivia-joke'); 
    const tastingTriviaJokeDisplay = document.getElementById('tasting-trivia-joke'); 

    const loadingImage = document.getElementById('loading-image');
    const welcomeImage = document.getElementById('welcome-image');
    const resultsImage = document.getElementById('results-image'); 
    const winnerImage = document.getElementById('winner-image'); 


    // State Variables
    let currentSessionId = null; 
    let currentPlayerId = null;
    let currentPlayerName = null;
    let isAdmin = false; 
    let fullEventConfig = null; 
    let selectedItemForRating = null; 


    // Data for trivia and jokes
    const MARGARITA_TRIVIA_JOKES = [
        "Trivia: The margarita is believed to have originated in Mexico in the 1930s or 40s. Its exact inventor is still debated!",
        "Joke: Why did the tequila get invited to all the parties? Because it brings out the best in everyone!",
        "Trivia: A traditional margarita recipe includes tequila, triple sec (or Cointreau), and lime juice.",
        "Joke: What do you call a sad strawberry in a margarita? A blueberry.",
        "Trivia: 'Margarita' is the Spanish word for 'daisy', a type of cocktail.",
        "Joke: My favorite exercise is a cross between a lunge and a crunch... I call it a Margarita!",
        "Trivia: The world's largest margarita was made in California, holding 10,500 gallons.",
        "Joke: Why did the lime stop in the middle of the road? Because it ran out of juice!",
        "Trivia: Salt on the rim is traditional, believed to enhance the sweet and sour flavors of the drink.",
        "Joke: What did the bartender say to the invisible man? 'I'm sorry, I can't serve you. You're not in sight!'"
    ];
    let currentTriviaJokeIndex = 0;


    // Utility Functions
    const utils = {
        generateId: (length = 8) => crypto.randomUUID().slice(0, length),
        showScreen: (screenToShow) => {
            screens.forEach(screen => screen.classList.add('hidden'));
            if (screenToShow) {
                screenToShow.classList.remove('hidden');
                // Update header based on screen
                if (screenToShow === welcomeScreen || screenToShow === loadingScreen || screenToShow === adminPanelScreen) {
                    headerTitle.textContent = "Margarita Taste Test";
                    headerSessionInfo.textContent = "";
                    appHeader.classList.remove('bg-blue-500', 'bg-yellow-500');
                    appHeader.classList.add('bg-green-500');
                } else if (screenToShow === tasteTestSection) {
                    headerTitle.textContent = fullEventConfig ? fullEventConfig.eventName : "Taste Test";
                    headerSessionInfo.textContent = `Session: ${fullEventConfig.eventId}`; // Display event ID in header
                    appHeader.classList.remove('bg-green-500', 'bg-yellow-500');
                    appHeader.classList.add('bg-blue-500');
                } else if (screenToShow === resultsScreen || screenToShow === winnerScreen) {
                    headerTitle.textContent = "Results";
                    headerSessionInfo.textContent = fullEventConfig ? `Session: ${fullEventConfig.eventId}` : "";
                    appHeader.classList.remove('bg-green-500', 'bg-blue-500');
                    appHeader.classList.add('bg-yellow-500');
                }
            } else {
                welcomeScreen.classList.remove('hidden');
                headerTitle.textContent = "Margarita Taste Test";
                headerSessionInfo.textContent = "";
            }
            window.scrollTo(0,0);
        },
        showAlert: (message, title = 'Alert') => {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
            return new Promise((resolve) => {
                alertOkBtn.onclick = () => {
                    alertModal.classList.add('hidden');
                    resolve();
                };
            });
        },
        validateInput: (input, type = 'text', maxLength = 100, allowEmpty = false) => {
            if (input === null || input === undefined) return false;
            if (typeof input !== 'string') input = String(input);
            const trimmedInput = input.trim();
            if (!allowEmpty && trimmedInput.length === 0) return false;
            if (trimmedInput.length > maxLength) return false;
            return true;
        },
        savePlayerInfo: (id, name) => {
            localStorage.setItem(`${APP_PREFIX}playerId`, id);
            localStorage.setItem(`${APP_PREFIX}playerName`, name);
        },
        loadPlayerInfo: () => {
            return {
                id: localStorage.getItem(`${APP_PREFIX}playerId`),
                name: localStorage.getItem(`${APP_PREFIX}playerName`)
            };
        },
        clearPlayerInfo: () => {
            localStorage.removeItem(`${APP_PREFIX}playerId`);
            localStorage.removeItem(`${APP_PREFIX}playerName`);
        },
        displayRandomTriviaJoke: () => {
            const joke = MARGARITA_TRIVIA_JOKES[currentTriviaJokeIndex];
            loadingTriviaJokeDisplay.textContent = joke;
            welcomeTriviaJokeDisplay.textContent = joke;
            tastingTriviaJokeDisplay.textContent = joke; 
            currentTriviaJokeIndex = (currentTriviaJokeIndex + 1) % MARGARITA_TRIVIA_JOKES.length;
        },
        startTriviaJokeRotation: () => {
            utils.displayRandomTriviaJoke(); 
            setInterval(utils.displayRandomTriviaJoke, 15000); 
        },
        displayRandomImage: () => { 
            const imageUrl = MARGARITA_IMAGES[currentImageIndex];
            loadingImage.src = imageUrl;
            welcomeImage.src = imageUrl;
            resultsImage.src = imageUrl;
            winnerImage.src = imageUrl;
            currentImageIndex = (currentImageIndex + 1) % MARGARITA_IMAGES.length;
        },
        startImageRotation: () => { 
            utils.displayRandomImage(); 
            setInterval(utils.displayRandomImage, 15000); 
        }
    };

    // API Interactions
    const api = {
        getActiveTestConfig: async () => {
            try {
                const response = await fetch('/api/get-active-test-config');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                return data;
            } catch (error) {
                console.error("Error fetching active test config:", error);
                utils.showAlert(`Failed to load test configuration: ${error.message}. Please try again later.`, "Error");
                return null;
            }
        },
        submitFeedback: async (feedbackData) => {
            try {
                const response = await fetch('/api/submit-feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedbackData)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                return data;
            } catch (error) {
                console.error("Error submitting feedback:", error);
                utils.showAlert(`Failed to submit feedback: ${error.message}.`, "Error");
                return null;
            }
        },
        updateEventData: async (eventData) => {
             try {
                const response = await fetch('/api/update-event-data', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                return data;
            } catch (error) {
                console.error("Error updating event data:", error);
                utils.showAlert(`Failed to update event data: ${error.message}. Only admin can add locations/items.`, "Error");
                return null;
            }
        }
    };

    // Session Management and UI Rendering
    const app = {
        init: async () => {
            appVersionDisplay.textContent = `Written by Phill. Version ${APP_VERSION}`; 
            utils.startTriviaJokeRotation(); 
            utils.startImageRotation(); 

            utils.showScreen(loadingScreen);
            const playerInfo = utils.loadPlayerInfo();
            if (playerInfo.id && playerInfo.name) {
                currentPlayerId = playerInfo.id;
                currentPlayerName = playerInfo.name;
                playerNameInput.value = currentPlayerName;
            } else {
                 currentPlayerId = utils.generateId(10); 
            }

            fullEventConfig = await api.getActiveTestConfig();
            if (fullEventConfig) {
                // Check for direct share URL
                const params = new URLSearchParams(window.location.search);
                const sharedSessionId = params.get('session');
                const sharedPlayerName = params.get('name');

                if (sharedSessionId && sharedPlayerName) {
                    history.replaceState({}, document.title, window.location.pathname); 
                    app.startTasting(sharedSessionId, sharedPlayerName); 
                    return; 
                }

                // Initial population of locations if needed (only for welcome screen to display options)
                if (fullEventConfig.locations.length === 0) {
                     utils.showAlert("No locations configured yet. Please ask Phill to set up the event in Admin Panel.", "No Locations");
                }


                utils.showScreen(welcomeScreen);
            } else {
                utils.showAlert("Could not load taste test configuration. Please refresh the page.", "Error Loading");
                utils.showScreen(welcomeScreen); 
            }
        },

        startTasting: async (sessionIdFromInput = null, nameFromUrl = null) => { 
            // Handle player name: from URL, from input, or set to Phill
            if (nameFromUrl) {
                currentPlayerName = nameFromUrl;
                playerNameInput.value = nameFromUrl; 
            } else if (!utils.validateInput(playerNameInput.value, 'text', 50)) { 
                utils.showAlert("Please enter a valid name (1-50 characters).");
                return;
            } else {
                currentPlayerName = playerNameInput.value.trim();
            }

            // Ensure player ID is set (either loaded, generated, or Phill's ID)
            if (!currentPlayerId) {
                currentPlayerId = utils.generateId(10);
            }
            utils.savePlayerInfo(currentPlayerId, currentPlayerName); 

            // Re-fetch full event config to ensure latest state including players and locations
            fullEventConfig = await api.getActiveTestConfig();
            if (!fullEventConfig) {
                 utils.showAlert("Failed to re-load configuration. Please try again.", "Error");
                 utils.showScreen(welcomeScreen);
                 return;
            }
            
            // Check if current user is admin for this event (even if not starting via admin button)
            isAdmin = (currentPlayerId === PHILL_ADMIN_ID); // Set isAdmin based on ID matching PHILL_ADMIN_ID

            // Ensure Phill's name is just "Phill" when acting as player
            if (currentPlayerId === PHILL_ADMIN_ID) {
                currentPlayerName = "Phill"; // Always display as "Phill" for consistency
            }

            // Handle currentSessionId based on join method
            if (sessionIdFromInput && sessionIdFromInput.trim() !== '') { 
                currentSessionId = sessionIdFromInput.trim();
                // If a player joins manually or via URL, ensure they are added to the session's player list
                const existingPlayerInSession = fullEventConfig.players.find(p => p.id === currentPlayerId);
                if (!existingPlayerInSession) {
                    fullEventConfig.players.push({ id: currentPlayerId, name: currentPlayerName, isAdmin: isAdmin });
                    await api.updateEventData(fullEventConfig); // Update KV with new player
                } else if (existingPlayerInSession.name !== currentPlayerName || existingPlayerInSession.isAdmin !== isAdmin) {
                    // Update player name or admin status if it changed
                    existingPlayerInSession.name = currentPlayerName;
                    existingPlayerInSession.isAdmin = isAdmin;
                    await api.updateEventData(fullEventConfig);
                }
            } else { // This branch should ideally not be hit with manual join button, but as fallback for existing session logic
                currentSessionId = `session_${fullEventConfig.eventId}_${Date.now()}`;
                utils.showAlert(`No Session ID entered. A new session ID "${currentSessionId}" will be used for your feedback.`, "Info");
            }


            currentPlayerNameDisplay.textContent = currentPlayerName; // Display Phill as "Phill"
            testEventNameDisplay.textContent = fullEventConfig.eventName;
            appHeader.classList.remove('bg-green-500', 'bg-yellow-500');
            appHeader.classList.add('bg-blue-500');

            app.populateLocationSelect(); // This will trigger renderRatingForm
            
            utils.showScreen(tasteTestSection);
            utils.showAlert(`Welcome, ${currentPlayerName}! Starting tasting for "${fullEventConfig.eventName}".`, "Session Joined");

        },

        startPhillAdminSession: async () => { 
            const pinAttempt = prompt("Enter Admin PIN:");
            if (pinAttempt !== ADMIN_PIN) {
                utils.showAlert("Incorrect PIN. Admin access denied.", "Access Denied");
                return;
            }

            isAdmin = true;
            currentPlayerId = PHILL_ADMIN_ID; 
            currentPlayerName = "Phill (Admin)"; // Admin panel shows "(Admin)"

            utils.savePlayerInfo(currentPlayerId, currentPlayerName); 

            fullEventConfig = await api.getActiveTestConfig();
            if (!fullEventConfig) {
                utils.showAlert("Could not load active event configuration for admin mode. Please ensure KV is set up.", "Error");
                utils.showScreen(welcomeScreen);
                return;
            }

            // Ensure Phill is in the player list for this event
            const existingPlayerInSession = fullEventConfig.players.find(p => p.id === currentPlayerId);
            if (!existingPlayerInSession) {
                fullEventConfig.players.push({ id: currentPlayerId, name: currentPlayerName, isAdmin: true });
                await api.updateEventData(fullEventConfig);
            } else if (existingPlayerInSession.name !== currentPlayerName || existingPlayerInSession.isAdmin !== true) {
                existingPlayerInSession.name = currentPlayerName;
                existingPlayerInSession.isAdmin = true;
                await api.updateEventData(fullEventConfig);
            }

            currentSessionId = fullEventConfig.eventId; 

            adminSessionIdDisplay.textContent = currentSessionId;
            newLocationAdminInput.value = ''; 
            participantNameShareInput.value = ''; 
            generatedShareLink.textContent = ''; 
            generatedShareLink.href = '#';
            copyShareLinkBtn.classList.add('hidden');

            app.renderAdminLocationsList(); 

            utils.showScreen(adminPanelScreen); 
            utils.showAlert(`Welcome, Phill! You are in Admin Mode for "${fullEventConfig.eventName}".`, "Admin Access");
        },

        renderAdminLocationsList: () => { 
            adminLocationsList.innerHTML = '';
            if (fullEventConfig.locations.length === 0) {
                adminLocationsList.innerHTML = '<li class="text-gray-500 italic">No locations added yet.</li>';
                return;
            }

            fullEventConfig.locations.forEach(loc => {
                const li = document.createElement('li');
                li.className = 'p-2 border rounded-md bg-white flex justify-between items-center shadow-sm';
                li.innerHTML = `
                    <span class="font-medium">${loc.locationName}</span>
                    <div class="flex space-x-2">
                        <button data-location-id="${loc.locationId}" class="remove-location-admin-btn text-red-500 hover:text-red-700 text-xs font-medium px-2 py-1 rounded">Remove</button>
                        <button data-location-id="${loc.locationId}" class="reset-feedback-admin-btn text-yellow-600 hover:text-yellow-800 text-xs font-medium px-2 py-1 rounded">Reset Feedback</button>
                    </div>
                `;
                adminLocationsList.appendChild(li);
            });

            document.querySelectorAll('.remove-location-admin-btn').forEach(button => {
                button.onclick = async (e) => {
                    const locationId = e.target.dataset.locationId;
                    if (confirm(`Are you sure you want to remove this location and ALL its associated ratings? This cannot be undone.`)) {
                        await app.removeLocation(locationId);
                    }
                };
            });
            document.querySelectorAll('.reset-feedback-admin-btn').forEach(button => {
                button.onclick = async (e) => {
                    const locationId = e.target.dataset.locationId;
                    if (confirm(`Are you sure you want to reset ALL feedback for this location? This cannot be undone.`)) {
                        await app.resetLocationFeedback(locationId);
                    }
                };
            });
        },
        
        removeLocation: async (locationId) => { 
            if (!isAdmin) { utils.showAlert("Permission denied.", "Error"); return; }

            fullEventConfig.locations = fullEventConfig.locations.filter(loc => loc.locationId !== locationId);

            const updatedEvent = {
                eventId: fullEventConfig.eventId,
                eventName: fullEventConfig.eventName,
                testTypeId: fullEventConfig.testTypeConfig.id,
                adminId: fullEventConfig.adminId, 
                locations: fullEventConfig.locations,
                activeLocationId: fullEventConfig.activeLocationId 
            };

            const response = await api.updateEventData(updatedEvent);
            if (response) {
                utils.showAlert("Location removed successfully (and its associated feedback on refresh).", "Success");
                newLocationAdminInput.value = ''; 
                fullEventConfig = await api.getActiveTestConfig(); 
                app.renderAdminLocationsList(); 
            }
        },

        resetLocationFeedback: async (locationId) => { 
            if (!isAdmin) { utils.showAlert("Permission denied.", "Error"); return; }
            
            utils.showAlert("Resetting feedback for this location would require a new API endpoint to delete KV data. (Not implemented in this version)", "Info");
            fullEventConfig = await api.getActiveTestConfig(); 
            app.renderAdminLocationsList(); 
        },

        generateShareLink: () => { 
            const participantName = participantNameShareInput.value.trim();
            if (!utils.validateInput(participantName, 'text', 50)) {
                utils.showAlert("Please enter a name for the participant.", "Invalid Input");
                return;
            }
            if (!fullEventConfig || !fullEventConfig.eventId) { // Ensure event is loaded
                utils.showAlert("Event configuration not loaded. Please try again or refresh.", "Error");
                return;
            }

            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?session=${fullEventConfig.eventId}&name=${encodeURIComponent(participantName)}`;
            generatedShareLink.href = shareUrl;
            generatedShareLink.textContent = shareUrl;
            copyShareLinkBtn.classList.remove('hidden');
            utils.showAlert("Share link generated!", "Link Ready");
        },

        renderRatingForm: () => {
            questionFields.innerHTML = '';
            itemRadioGroup.classList.add('hidden'); 
            ratingForm.classList.remove('hidden'); 

            const ratingExplanationDiv = ratingForm.querySelector('.rating-explanation');
            if (ratingExplanationDiv) {
                ratingExplanationDiv.innerHTML = RATING_EXPLANATION; 
            }

            // Insert the general instruction paragraph above the question fields
            questionFields.insertAdjacentHTML('beforebegin', '<p class="mb-4 text-gray-600 italic">Rate each aspect based on how well it matches your ideal margarita. 5 is perfect for you, 0 is the complete opposite of what you prefer.</p>');


            if (!fullEventConfig || !fullEventConfig.testTypeConfig || !fullEventConfig.testTypeConfig.questions) {
                utils.showAlert("No rating questions configured for this test type.", "Error");
                ratingForm.classList.add('hidden');
                return;
            }

            const currentSelectedLocation = fullEventConfig.locations.find(loc => loc.locationId === locationSelect.value);

            if (currentSelectedLocation && currentSelectedLocation.items && currentSelectedLocation.items.length > 0) {
                itemRadioGroup.classList.remove('hidden');
                itemRadioGroup.innerHTML = `<h3 class="text-xl font-semibold mb-3">Which Margarita are you tasting here?</h3>`;
                currentSelectedLocation.items.forEach(item => {
                    const radioDiv = document.createElement('div');
                    radioDiv.className = 'item-radio-group';
                    radioDiv.innerHTML = `
                        <label>
                            <input type="radio" name="selectedItem" value="${item.itemId}" data-item-name="${item.itemName}" required>
                            <span>${item.itemName}</span>
                        </label>
                    `;
                    itemRadioGroup.appendChild(radioDiv);
                });
                itemRadioGroup.onchange = (e) => {
                    if (e.target.name === 'selectedItem') {
                        selectedItemForRating = {
                            itemId: e.target.value,
                            itemName: e.target.dataset.itemName
                        };
                    }
                };
                
                // Auto-select first item or previously selected one if available
                const savedSelectedItem = selectedItemForRating ? currentSelectedLocation.items.find(item => item.itemId === selectedItemForRating.itemId) : null;
                if (savedSelectedItem) {
                    const radioToSelect = itemRadioGroup.querySelector(`input[value="${savedSelectedItem.itemId}"]`);
                    if (radioToSelect) {
                        radioToSelect.checked = true;
                        selectedItemForRating = savedSelectedItem;
                    }
                } else {
                    const firstItemRadio = itemRadioGroup.querySelector('input[type="radio"]');
                    if (firstItemRadio) {
                        firstItemRadio.checked = true;
                        selectedItemForRating = {
                            itemId: firstItemRadio.value,
                            itemName: firstItemRadio.dataset.itemName
                        };
                    }
                }
            } else {
                itemRadioGroup.classList.add('hidden'); // Hide if no items
                selectedItemForRating = null; 
                utils.showAlert("No items available for this location. Please add items via Admin Panel or select a different location.", "No Items");
                ratingForm.classList.add('hidden'); // Hide form if no items
                return;
            }

            // Render questions based on testTypeConfig
            fullEventConfig.testTypeConfig.questions.forEach(q => {
                let defaultValue = Math.round(((q.min || 0) + (q.max || 5)) / 2); // Default to middle for sliders/0-5

                if (q.type === 'rating_0_5') {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between';

                    const label = document.createElement('label');
                    label.htmlFor = `question-${q.id}`;
                    label.textContent = `${q.text} ${q.required ? '*' : ''}:`;
                    label.className = 'mb-1 sm:mb-0 text-gray-700 font-medium';

                    const select = document.createElement('select');
                    select.id = `question-${q.id}`;
                    select.name = q.id;
                    select.className = 'p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto';
                    select.required = q.required;

                    for (let i = MAX_RATING; i >= 0; i--) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `${i} star${i !== 1 ? 's' : ''}`;
                        if (i === defaultValue) { 
                            option.selected = true;
                        }
                        select.appendChild(option);
                    }
                    questionDiv.appendChild(label);
                    questionDiv.appendChild(select);
                    questionFields.appendChild(questionDiv);
                } else if (q.type === 'rating_slider_with_labels') { 
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'flex flex-col mb-4 p-2 border rounded-lg bg-gray-100'; 

                    const label = document.createElement('label');
                    label.htmlFor = `question-${q.id}`;
                    label.textContent = `${q.text} ${q.required ? '*' : ''}:`;
                    label.className = 'mb-2 text-gray-700 font-medium'; 
                    questionDiv.appendChild(label);

                    const sliderContainer = document.createElement('div'); 
                    sliderContainer.className = 'flex flex-col items-center w-full'; 

                    const slider = document.createElement('input');
                    slider.type = 'range';
                    slider.id = `question-${q.id}`;
                    slider.name = q.id;
                    slider.min = q.min || 0;
                    slider.max = q.max || 5;
                    slider.step = q.step || 1;
                    slider.value = defaultValue; 
                    slider.className = 'w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2'; 
                    sliderContainer.appendChild(slider);

                    const labelsContainer = document.createElement('div'); 
                    labelsContainer.className = 'flex justify-between w-full text-xs text-gray-500 mt-1';
                    if (q.labels && q.labels.length > 0) {
                         const minLabel = document.createElement('span');
                         minLabel.textContent = q.labels[0];
                         labelsContainer.appendChild(minLabel);

                         const maxLabel = document.createElement('span');
                         maxLabel.textContent = q.labels[q.labels.length - 1];
                         labelsContainer.appendChild(maxLabel);
                    }
                    sliderContainer.appendChild(labelsContainer);


                    const valueDisplay = document.createElement('span'); 
                    valueDisplay.className = 'text-sm text-gray-800 mt-2 font-semibold p-1 bg-blue-100 rounded-md'; 
                    valueDisplay.textContent = q.labels ? q.labels[slider.value] : slider.value; 
                    sliderContainer.appendChild(valueDisplay);

                    slider.oninput = (e) => {
                        valueDisplay.textContent = q.labels ? q.labels[e.target.value] : e.target.value;
                    };
                    questionDiv.appendChild(sliderContainer);
                    questionFields.appendChild(questionDiv);

                } else if (q.type === 'text_long') {
                    // Comments field is separate at the bottom
                } else {
                    console.warn(`Unsupported question type: ${q.type}`);
                }
            });
        },

        populateLocationSelect: () => {
            locationSelect.innerHTML = '';
            if (fullEventConfig.locations.length === 0) {
                 locationSelect.innerHTML = '<option value="">No locations added by admin</option>';
                 locationSelect.disabled = true;
                 itemRadioGroup.classList.add('hidden'); 
                 ratingForm.classList.add('hidden'); 
                 return;
            }
            locationSelect.disabled = false;
            ratingForm.classList.remove('hidden'); 

            fullEventConfig.locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.locationId;
                option.textContent = loc.locationName;
                if (loc.locationId === fullEventConfig.activeLocationId) {
                    option.selected = true;
                }
                locationSelect.appendChild(option);
            });
            // This event dispatch ensures that when the locations are populated,
            // the item selection and form rendering logic is immediately triggered
            // for the default/selected location.
            locationSelect.dispatchEvent(new Event('change')); 
        },

        populateItemSelect: (selectedLocationId) => { 
            const currentSelectedLocation = fullEventConfig.locations.find(loc => loc.locationId === selectedLocationId);
            if (currentSelectedLocation && currentSelectedLocation.items && currentSelectedLocation.items.length > 0) {
                itemRadioGroup.classList.remove('hidden'); 
                ratingForm.classList.remove('hidden'); 
                app.renderRatingForm(); 
            } else {
                itemRadioGroup.classList.add('hidden'); 
                selectedItemForRating = null; 
                // Only show this alert if not an admin AND on the tasting page, to avoid premature alerts on welcome
                if (currentSelectedLocation && currentSelectedLocation.items && currentSelectedLocation.items.length === 0 && (document.getElementById('taste-test-section').classList.contains('hidden') === false)) {
                     utils.showAlert("No items available for this location. Please add items via Admin Panel or select a different location.", "No Items");
                }
                ratingForm.classList.add('hidden'); 
            }
        },

        submitRating: async (e) => {
            e.preventDefault();

            const locationId = locationSelect.value;
            const selectedItemRadio = itemRadioGroup.querySelector('input[name="selectedItem"]:checked');

            if (!locationId || !selectedItemRadio) {
                utils.showAlert("Please select both a location and which item you are rating.", "Missing Information");
                return;
            }
            const itemId = selectedItemRadio.value;
            const itemName = selectedItemRadio.dataset.itemName; 


            const ratings = {};
            let allRequiredQuestionsAnswered = true;
            fullEventConfig.testTypeConfig.questions.forEach(q => {
                const inputElement = document.getElementById(`question-${q.id}`);
                if (inputElement) {
                    let value;
                    if (q.type === 'rating_0_5' || q.type === 'rating_slider_with_labels') {
                        value = parseInt(inputElement.value, 10);
                        if (q.required && (isNaN(value) || value < (q.min || 0) || value > (q.max || 5))) {
                             allRequiredQuestionsAnswered = false;
                        }
                    } else if (q.type === 'text_short' || q.type === 'text_medium' || q.type === 'text_long') {
                         value = inputElement.value.trim();
                         if (q.required && value.length === 0) {
                             allRequiredQuestionsAnswered = false;
                         }
                    } else { 
                        value = inputElement.value;
                        if (q.required && !value) {
                             allRequiredQuestionsAnswered = false;
                        }
                    }
                    ratings[q.id] = value;
                }
            });

            if (!allRequiredQuestionsAnswered) {
                 utils.showAlert("Please answer all required questions.", "Missing Answers");
                 return;
            }

            const comments = commentsTextarea.value.trim();

            const feedbackData = {
                eventId: fullEventConfig.eventId,
                locationId: locationId,
                itemId: itemId,
                itemName: itemName, 
                playerId: currentPlayerId,
                playerName: currentPlayerName,
                sessionId: currentSessionId, 
                ratings: ratings,
                comments: comments
            };

            const response = await api.submitFeedback(feedbackData);
            if (response) {
                utils.showAlert("Feedback submitted successfully!", "Success");
                ratingForm.reset();
                selectedItemForRating = null; 
                fullEventConfig = await api.getActiveTestConfig(); 
                app.populateLocationSelect(); 
            }
        },

        renderResults: () => {
            utils.showScreen(resultsScreen);
            resultsSessionIdDisplay.textContent = currentSessionId;
            resultsSummary.innerHTML = '';

            if (!fullEventConfig || !fullEventConfig.locations.length) {
                resultsSummary.innerHTML = '<p class="text-gray-500">No locations or ratings to display results.</p>';
                viewWinnerBtn.classList.add('hidden');
                return;
            }
            viewWinnerBtn.classList.remove('hidden');

            let allScores = []; 

            fullEventConfig.locations.forEach(location => {
                location.items.forEach(item => {
                    const itemResultsDiv = document.createElement('div');
                    itemResultsDiv.className = 'p-4 border rounded-lg mb-4 bg-yellow-50 shadow';
                    itemResultsDiv.innerHTML = `<h3 class="text-xl font-semibold mb-3 text-yellow-800">${location.locationName} - ${item.itemName}</h3>`;

                    const itemRatings = fullEventConfig.feedback.filter(
                        f => f.locationId === location.locationId && f.itemId === item.itemId
                    );

                    if (itemRatings.length === 0) {
                        itemResultsDiv.innerHTML += '<p class="text-gray-500 italic">No ratings yet for this item.</p>';
                        resultsSummary.appendChild(itemResultsDiv);
                        return;
                    }

                    const averageRatings = {};
                    const ratingCounts = {};
                    let totalOverallScore = 0;
                    let overallRatingCount = 0;

                    fullEventConfig.testTypeConfig.questions.forEach(q => {
                        averageRatings[q.id] = 0;
                        ratingCounts[q.id] = 0;
                    });
                    const allComments = [];

                    itemRatings.forEach(feedback => {
                        Object.entries(feedback.ratings).forEach(([critId, value]) => {
                            averageRatings[critId] += value;
                            ratingCounts[critId]++;
                            totalOverallScore += value;
                            overallRatingCount++;
                        });
                        if (feedback.comments) {
                            allComments.push(`<strong>${feedback.playerName}</strong>: ${feedback.comments}`);
                        }
                    });

                    const avgTable = document.createElement('table');
                    avgTable.className = 'min-w-full divide-y divide-gray-200 mb-3';
                    const anthead = avgTable.createTHead();
                    anthead.innerHTML = `<tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Criterion</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Rating</th></tr>`;
                    const anbody = avgTable.createTBody();
                    anbody.className = "bg-white divide-y divide-gray-200";

                    fullEventConfig.testTypeConfig.questions.forEach(q => {
                        const avg = ratingCounts[q.id] > 0 ? (averageRatings[q.id] / ratingCounts[q.id]).toFixed(1) : 'N/A';
                        const row = anbody.insertRow();
                        row.innerHTML = `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${q.text}</td><td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${avg}/${MAX_RATING}</td>`;
                    });
                    itemResultsDiv.appendChild(avgTable);

                    const overallAvg = overallRatingCount > 0 ? (totalOverallScore / overallRatingCount).toFixed(1) : 'N/A';
                    itemResultsDiv.innerHTML += `<p class="text-sm font-semibold text-gray-700 mt-2">Overall Average Score: ${overallAvg}/${MAX_RATING} (from ${itemRatings.length} total submissions)</p>`;

                    if (overallAvg !== 'N/A') {
                        allScores.push({
                            locationId: location.locationId,
                            locationName: location.locationName,
                            itemId: item.itemId,
                            itemName: item.itemName,
                            score: parseFloat(overallAvg)
                        });
                    }

                    if (allComments.length > 0) {
                        itemResultsDiv.innerHTML += `<h4 class="text-md font-semibold mt-3 mb-1 text-yellow-700">Comments:</h4><ul class="list-disc pl-5 text-xs space-y-1">${allComments.map(comment => `<li>${comment}</li>`).join('')}</ul>`;
                    } else {
                        itemResultsDiv.innerHTML += `<p class="text-xs text-gray-500 italic mt-2">No comments submitted for this item.</p>`;
                    }
                    resultsSummary.appendChild(itemResultsDiv);
                });
            });
            resultsSummary.dataset.allScores = JSON.stringify(allScores);
        },

        renderWinner: () => {
            utils.showScreen(winnerScreen);
            const allScores = JSON.parse(resultsSummary.dataset.allScores || '[]');

            if (allScores.length === 0) {
                winningItemDetails.innerHTML = '<p class="text-lg text-gray-600">No items rated yet to determine a winner!</p>';
                return;
            }

            allScores.sort((a, b) => b.score - a.score);
            const topScore = allScores[0].score;
            const winners = allScores.filter(item => item.score === topScore);

            let winnerHtml = '';
            if (winners.length === 1) {
                winnerHtml = `
                    <p class="text-2xl font-bold text-green-700 mb-2">${winners[0].itemName} at ${winners[0].locationName}</p>
                    <p class="text-xl text-gray-800">With an average score of: <span class="font-bold text-green-600">${winners[0].score}/${MAX_RATING}</span></p>
                `;
            } else {
                winnerHtml = `
                    <p class="text-2xl font-bold text-purple-700 mb-2">It's a Tie!</p>
                    <p class="text-xl text-gray-800">The winning items are:</p>
                    <ul class="list-disc pl-8 mt-2 text-lg font-semibold text-purple-600">
                        ${winners.map(w => `<li>${w.itemName} at ${w.locationName} (${w.score}/${MAX_RATING})</li>`).join('')}
                    </ul>
                `;
            }
             winningItemDetails.innerHTML = winnerHtml + `<p class="mt-4 text-md text-gray-700">Congratulations to all participants!</p>`;
        },

        addLocation: async () => {
            if (!isAdmin) {
                utils.showAlert("Permission denied.", "Error"); 
                return;
            }
            const newLocName = newLocationAdminInput.value.trim(); 
            if (!utils.validateInput(newLocName, 'text', 100)) {
                utils.showAlert("Please enter a valid location name (1-100 characters).", "Invalid Input");
                return;
            }

            const newLocation = {
                locationId: `loc_${utils.generateId(6)}`,
                locationName: newLocName,
                items: [], 
                allowCustomItem: true 
            };

            fullEventConfig.locations.push(newLocation);
            fullEventConfig.activeLocationId = newLocation.locationId; 

            const updatedEvent = {
                eventId: fullEventConfig.eventId,
                eventName: fullEventConfig.eventName,
                testTypeId: fullEventConfig.testTypeConfig.id,
                adminId: fullEventConfig.adminId, 
                locations: fullEventConfig.locations,
                activeLocationId: fullEventConfig.activeLocationId
            };

            const response = await api.updateEventData(updatedEvent);
            if (response) {
                utils.showAlert("Location added successfully! It is now the active location.", "Success");
                newLocationAdminInput.value = ''; 
                fullEventConfig = await api.getActiveTestConfig(); 
                app.renderAdminLocationsList(); 
            }
        },

        // Removed addItem: async () => { ... } as per request.
        // Item management is now purely via KV editing or initial setup.
        // The add-item-admin-btn and new-item-name-input HTML elements
        // within taste-test-section are now effectively unused/inert.
        // If you need UI for adding items, it would need to be rebuilt in the admin panel.
    };

    // Event Listeners
    startTestBtn.addEventListener('click', () => { // "Join Test Manually" button
        const sessionId = sessionIdInput.value;
        app.startTasting(sessionId);
    });

    // ADMIN BUTTON EVENT LISTENER
    phillStartsSessionBtn.addEventListener('click', app.startPhillAdminSession);
    
    // ADMIN PANEL BUTTONS
    addLocationFromAdminBtn.addEventListener('click', app.addLocation); 
    generateShareLinkBtn.addEventListener('click', app.generateShareLink);
    adminCopySessionIdBtn.addEventListener('click', () => { // Listener for admin panel copy ID
        if (adminSessionIdDisplay.textContent) {
            navigator.clipboard.writeText(adminSessionIdDisplay.textContent)
                .then(() => utils.showAlert("Session ID copied to clipboard!", "Copied!"))
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    utils.showAlert("Failed to copy Session ID. Please copy it manually.", "Error");
                });
        }
    });
    copyShareLinkBtn.addEventListener('click', () => { // Listener for share link copy button
        if (generatedShareLink.textContent) {
            navigator.clipboard.writeText(generatedShareLink.textContent)
                .then(() => utils.showAlert("Share link copied to clipboard!", "Copied!"))
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    utils.showAlert("Failed to copy link. Please copy it manually.", "Error");
                });
        }
    });

    adminViewTastingBtn.addEventListener('click', () => {
        utils.showScreen(tasteTestSection);
        app.populateLocationSelect(); 
        // No more addItemAdminBtn here
        // The HTML elements newLocationNameInput, addLocationAdminBtn, addItemAdminBtn, newItemNameInput
        // within the taste-test-section are now effectively unused/inert.
    });
    adminViewResultsBtn.addEventListener('click', app.renderResults);
    adminEndSessionBtn.addEventListener('click', () => {
        utils.clearPlayerInfo(); 
        currentSessionId = null;
        isAdmin = false; 
        utils.showScreen(welcomeScreen);
        playerNameInput.value = '';
        sessionIdInput.value = '';
    });


    // COPY SESSION ID BUTTON EVENT LISTENER (on taste-test-section)
    // This button is removed from HTML, so this listener is inert.

    locationSelect.addEventListener('change', (e) => {
        app.populateItemSelect(e.target.value);
    });

    ratingForm.addEventListener('submit', app.submitRating);
    viewResultsBtn.addEventListener('click', app.renderResults);
    leaveSessionBtn.addEventListener('click', () => {
        utils.clearPlayerInfo(); 
        currentSessionId = null; 
        utils.showScreen(welcomeScreen);
        playerNameInput.value = '';
        sessionIdInput.value = '';
    });
    
    // Removed specific addItemAdminBtn event listener.
    // Removed specific addLocationAdminBtn event listener.

    // REFRESH LOCATIONS BUTTON EVENT LISTENER
    refreshLocationsBtn.addEventListener('click', async () => {
        utils.showAlert("Checking for new locations/items...", "Updating...");
        fullEventConfig = await api.getActiveTestConfig(); // Re-fetch all config from KV
        if (fullEventConfig) {
            app.populateLocationSelect(); 
            utils.showAlert("Locations updated!", "Success");
        } else {
            utils.showAlert("Failed to refresh locations. Please try again.", "Error");
        }
    });


    viewWinnerBtn.addEventListener('click', app.renderWinner);
    backToTastingBtn.addEventListener('click', () => utils.showScreen(tasteTestSection));
    winnerBackToResultsBtn.addEventListener('click', () => utils.showScreen(resultsScreen));
    winnerNewSessionBtn.addEventListener('click', () => {
        utils.clearPlayerInfo();
        currentSessionId = null;
        utils.showScreen(welcomeScreen);
        playerNameInput.value = '';
        sessionIdInput.value = '';
    });

    // Initial app load
    app.init();
</script>
</body>
</html>