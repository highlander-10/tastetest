<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taste Test Challenge!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style id="themeStyle">
        :root {
            --primary-color: #4F46E5; /* Indigo */
            --secondary-color: #EC4899; /* Pink */
            --background-color: #F3F4F6; /* Gray 100 */
            --text-color: #1F2937; /* Gray 800 */
            --card-background-color: #FFFFFF;
            --font-family: 'Inter', sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .themed-background { background-color: var(--background-color); }
        .themed-text { color: var(--text-color); }
        .themed-primary-text { color: var(--primary-color); }
        .themed-primary-bg { background-color: var(--primary-color); }
        .themed-secondary-text { color: var(--secondary-color); }
        .themed-secondary-bg { background-color: var(--secondary-color); }
        .themed-card-bg { background-color: var(--card-background-color); }
        .themed-button { background-color: var(--primary-color); color: white; }
        .themed-button:hover { filter: brightness(110%); }
        .themed-input { border-color: var(--primary-color); }
        .themed-input:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 2px var(--secondary-color); }
        input[type="radio"].themed-primary-text, input[type="checkbox"].themed-primary-text {
            color: var(--primary-color);
        }
         input[type="radio"].themed-primary-text:focus, input[type="checkbox"].themed-primary-text:focus {
            ring-color: var(--secondary-color);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 themed-background transition-colors duration-500">

    <div id="loadingIndicator" class="fixed inset-0 bg-slate-500 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
        <p class="ml-4 text-white text-xl">Loading...</p>
    </div>

    <!-- Landing Page Section -->
    <div id="landingPageSection" class="w-full max-w-2xl text-center">
        <div class="themed-card-bg shadow-xl rounded-lg p-6 md:p-10">
            <header class="mb-8">
                <h1 id="landingTitle" class="text-4xl md:text-5xl font-bold themed-primary-text">Welcome!</h1>
            </header>
            <div id="landingMessageArea" class="mb-6 p-3 rounded-md text-sm themed-text bg-opacity-50 themed-card-bg">
                <p class="text-lg mb-2">Get ready to put your taste buds to the test!</p>
                <p id="currentEventInfo" class="text-md themed-secondary-text">Fetching current event details...</p>
                <p id="currentLocationInfo" class="text-md themed-secondary-text"></p>
            </div>
            <button id="proceedToTestButton" class="themed-button font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-opacity-75 hidden">
                Start Tasting at Current Location
            </button>
            <div id="noActiveTestMessage" class="hidden mt-4 p-3 bg-yellow-100 text-yellow-700 rounded-md">
                <p>No taste test is currently active. Please check back later or contact an admin.</p>
            </div>
        </div>
    </div>

    <!-- Taste Test Form Section (Initially Hidden) -->
    <div id="tasteTestSection" class="w-full max-w-2xl hidden">
        <div id="appContainer">
            <div class="themed-card-bg shadow-xl rounded-lg p-6 md:p-10">
                <header class="mb-8 text-center">
                    <h1 id="testTitle" class="text-3xl md:text-4xl font-bold themed-primary-text">Taste Test</h1>
                    <p id="testLocationName" class="text-xl themed-secondary-text"></p>
                </header>

                <div id="messageArea" class="hidden p-3 rounded-md text-sm mb-6"></div>

                <form id="submissionForm">
                    <!-- Item Selection Area -->
                    <div id="itemSelectionArea" class="mb-6">
                        <label for="itemSelect" class="block text-sm font-medium themed-text mb-1">What are you tasting?</label>
                        <select id="itemSelect" name="itemSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-secondary-color focus:border-secondary-color sm:text-sm rounded-md themed-input themed-card-bg themed-text">
                            <!-- Options will be populated by JS -->
                        </select>
                        <div id="customItemEntry" class="mt-3 hidden">
                            <label for="customItemName" class="block text-sm font-medium themed-text mb-1">Custom Item Name:</label>
                            <input type="text" id="customItemName" name="customItemName" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none sm:text-sm themed-input themed-card-bg themed-text">
                        </div>
                    </div>

                    <div id="formContainer" class="space-y-6">
                        <!-- Questions will be rendered here by JavaScript -->
                    </div>

                    <div class="mt-10 text-center">
                        <button type="submit" id="submitButton" class="themed-button font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-opacity-75 hidden">
                            Submit Feedback
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="text-center mt-8 fixed bottom-4 w-full">
        <p class="text-sm themed-text opacity-70">Taste Testing App</p>
    </footer>

    <script type="module">
        // UI Elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const landingPageSection = document.getElementById('landingPageSection');
        const landingTitle = document.getElementById('landingTitle');
        const currentEventInfo = document.getElementById('currentEventInfo');
        const currentLocationInfo = document.getElementById('currentLocationInfo');
        const proceedToTestButton = document.getElementById('proceedToTestButton');
        const noActiveTestMessage = document.getElementById('noActiveTestMessage');
        
        const tasteTestSection = document.getElementById('tasteTestSection');
        const testTitleElement = document.getElementById('testTitle'); // For the test type name (e.g., Margarita Rating)
        const testLocationName = document.getElementById('testLocationName'); // For the specific location
        const itemSelectionArea = document.getElementById('itemSelectionArea');
        const itemSelect = document.getElementById('itemSelect');
        const customItemEntry = document.getElementById('customItemEntry');
        const customItemNameInput = document.getElementById('customItemName');
        
        const formContainer = document.getElementById('formContainer');
        const submissionForm = document.getElementById('submissionForm');
        const submitButton = document.getElementById('submitButton');
        const messageArea = document.getElementById('messageArea');

        let fullEventConfig = null; // Will store { eventId, eventName, activeLocation, testTypeConfig }

        // API Endpoints
        const API_BASE_URL = '/api';
        const GET_ACTIVE_EVENT_CONFIG_ENDPOINT = `${API_BASE_URL}/get-active-event-config`; // Renamed for clarity
        const SUBMIT_FEEDBACK_ENDPOINT = `${API_BASE_URL}/submit-feedback`;

        async function initializeLandingPage() {
            showLoading(true);
            try {
                const response = await fetch(GET_ACTIVE_EVENT_CONFIG_ENDPOINT);
                if (!response.ok) {
                    if (response.headers.get("content-type")?.includes("application/json")) {
                        const errorData = await response.json();
                        if (errorData.message) {
                            landingTitle.textContent = "Taste Test Challenge";
                            currentEventInfo.textContent = errorData.message;
                            currentLocationInfo.textContent = "";
                            proceedToTestButton.classList.add('hidden');
                            noActiveTestMessage.classList.remove('hidden');
                            noActiveTestMessage.textContent = errorData.message;
                            fullEventConfig = null;
                            applyTheme(null); // Apply default theme
                            return;
                        }
                    }
                    throw new Error(`Failed to load event configuration. Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.config && data.config.eventId && data.config.activeLocation) {
                    fullEventConfig = data.config;
                    console.log("Fetched full event config:", fullEventConfig);

                    landingTitle.textContent = fullEventConfig.eventName || "Taste Test Challenge!";
                    currentEventInfo.textContent = `Event: ${fullEventConfig.eventName}`;
                    currentLocationInfo.textContent = `Current Location: ${fullEventConfig.activeLocation.locationName}`;
                    
                    proceedToTestButton.classList.remove('hidden');
                    noActiveTestMessage.classList.add('hidden');
                    applyTheme(fullEventConfig.testTypeConfig?.theme); 
                } else if (data && data.message) {
                    landingTitle.textContent = "Taste Test Challenge";
                    currentEventInfo.textContent = data.message;
                    currentLocationInfo.textContent = "";
                    proceedToTestButton.classList.add('hidden');
                    noActiveTestMessage.classList.remove('hidden');
                    noActiveTestMessage.textContent = data.message;
                    fullEventConfig = null;
                    applyTheme(null);
                } else {
                    landingTitle.textContent = "Taste Test Challenge";
                    currentEventInfo.textContent = "Could not determine the current taste test event.";
                    currentLocationInfo.textContent = "";
                    proceedToTestButton.classList.add('hidden');
                    noActiveTestMessage.classList.remove('hidden');
                    noActiveTestMessage.textContent = "No active event is configured or the configuration is invalid.";
                    fullEventConfig = null;
                    applyTheme(null);
                }
            } catch (error) {
                console.error("Initialization error:", error);
                landingTitle.textContent = "Taste Test Challenge";
                currentEventInfo.textContent = "Error loading taste test details.";
                currentLocationInfo.textContent = "";
                displayMessage(`Error initializing: ${error.message}`, "error", document.getElementById('landingMessageArea'));
                proceedToTestButton.classList.add('hidden');
                noActiveTestMessage.classList.remove('hidden');
                noActiveTestMessage.textContent = "An error occurred while fetching event details.";
                fullEventConfig = null;
                applyTheme(null);
            } finally {
                showLoading(false);
            }
        }

        function loadAndDisplayActiveTestForm() {
            if (!fullEventConfig || !fullEventConfig.activeLocation || !fullEventConfig.testTypeConfig) {
                displayMessage("No active event/location configuration available.", "error", document.getElementById('landingMessageArea'));
                return;
            }
            landingPageSection.classList.add('hidden');
            tasteTestSection.classList.remove('hidden');
            
            testTitleElement.textContent = fullEventConfig.testTypeConfig.displayName || "Rate This Item";
            testLocationName.textContent = `At: ${fullEventConfig.activeLocation.locationName}`;

            populateItemSelect();
            renderBaseQuestions(); // Render the general questions for the test type
        }
        
        function populateItemSelect() {
            itemSelect.innerHTML = ''; // Clear existing options
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "-- Select Item --";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            itemSelect.appendChild(defaultOption);

            fullEventConfig.activeLocation.items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.itemId;
                option.textContent = item.itemName;
                itemSelect.appendChild(option);
            });

            if (fullEventConfig.activeLocation.allowCustomItem) {
                const customOption = document.createElement('option');
                customOption.value = "custom";
                customOption.textContent = "Add Custom Item...";
                itemSelect.appendChild(customOption);
            }
            customItemEntry.classList.add('hidden'); // Hide custom input initially
        }

        itemSelect.addEventListener('change', (event) => {
            if (event.target.value === "custom") {
                customItemEntry.classList.remove('hidden');
                customItemNameInput.required = true;
                customItemNameInput.focus();
            } else {
                customItemEntry.classList.add('hidden');
                customItemNameInput.required = false;
                customItemNameInput.value = ''; // Clear if previously entered
            }
        });


        proceedToTestButton.addEventListener('click', loadAndDisplayActiveTestForm);

        function applyTheme(themeConfig) {
            const defaultTheme = {
                primaryColor: '#4F46E5', 
                secondaryColor: '#EC4899',
                backgroundColor: '#F3F4F6',
                textColor: '#1F2937',
                cardBackgroundColor: '#FFFFFF',
                fontFamily: "'Inter', sans-serif",
                backgroundImage: ''
            };
            const themeToApply = themeConfig ? { ...defaultTheme, ...themeConfig } : defaultTheme;

            document.documentElement.style.setProperty('--primary-color', themeToApply.primaryColor);
            document.documentElement.style.setProperty('--secondary-color', themeToApply.secondaryColor);
            document.documentElement.style.setProperty('--background-color', themeToApply.backgroundColor);
            document.documentElement.style.setProperty('--text-color', themeToApply.textColor);
            document.documentElement.style.setProperty('--card-background-color', themeToApply.cardBackgroundColor);
            document.documentElement.style.setProperty('--font-family', themeToApply.fontFamily);
            
            document.body.style.backgroundImage = themeToApply.backgroundImage ? `url('${themeToApply.backgroundImage}')` : '';
            document.body.style.backgroundSize = themeToApply.backgroundImage ? 'cover' : '';
            document.body.style.backgroundPosition = themeToApply.backgroundImage ? 'center' : '';
            document.body.style.backgroundAttachment = themeToApply.backgroundImage ? 'fixed' : '';
        }

        function renderBaseQuestions() {
            if (!fullEventConfig || !fullEventConfig.testTypeConfig || !fullEventConfig.testTypeConfig.questions) {
                formContainer.innerHTML = '<p class="text-center themed-text">No questions found for this taste test type.</p>';
                submitButton.classList.add('hidden');
                return;
            }

            formContainer.innerHTML = ''; // Clear previous questions
            const questions = fullEventConfig.testTypeConfig.questions;

            questions.forEach(q => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'mb-6';
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium themed-text mb-1';
                label.htmlFor = q.id;
                label.textContent = q.text + (q.required ? ' *' : '');
                questionDiv.appendChild(label);

                if (q.type === 'text_short' || q.type === 'text_medium') {
                    const input = document.createElement('input');
                    input.type = 'text'; input.id = q.id; input.name = q.id;
                    input.className = 'mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none sm:text-sm themed-input themed-card-bg themed-text';
                    if (q.required) input.required = true;
                    questionDiv.appendChild(input);
                } else if (q.type === 'text_long') {
                    const textarea = document.createElement('textarea');
                    textarea.id = q.id; textarea.name = q.id; textarea.rows = 4;
                    textarea.className = 'mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none sm:text-sm themed-input themed-card-bg themed-text';
                    if (q.required) textarea.required = true;
                    questionDiv.appendChild(textarea);
                } else if (q.type === 'rating_1_5' || q.type === 'rating_1_10') {
                    const maxRating = q.type === 'rating_1_5' ? 5 : 10;
                    const ratingContainer = document.createElement('div');
                    ratingContainer.className = 'flex space-x-2 mt-2 flex-wrap';
                    for (let i = 1; i <= maxRating; i++) {
                        const radioDiv = document.createElement('div');
                        radioDiv.className = 'flex items-center mr-2 mb-1';
                        const radio = document.createElement('input');
                        radio.type = 'radio'; radio.id = `${q.id}_${i}`; radio.name = q.id; radio.value = i;
                        radio.className = 'h-4 w-4 themed-primary-text focus:ring-secondary-color border-gray-300';
                        if (q.required) radio.required = true;
                        const radioLabel = document.createElement('label');
                        radioLabel.htmlFor = `${q.id}_${i}`; radioLabel.textContent = i;
                        radioLabel.className = 'ml-1.5 text-sm themed-text';
                        radioDiv.appendChild(radio); radioDiv.appendChild(radioLabel);
                        ratingContainer.appendChild(radioDiv);
                    }
                    questionDiv.appendChild(ratingContainer);
                } else if (q.type === 'rating_1_5_custom_labels') {
                    const ratingContainer = document.createElement('div');
                    ratingContainer.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-2 flex-wrap';
                    if (q.labels && Array.isArray(q.labels)) {
                        q.labels.forEach((labelText, index) => {
                            const value = index + 1;
                            const radioDiv = document.createElement('div');
                            radioDiv.className = 'flex items-center mr-2 mb-1';
                            const radio = document.createElement('input');
                            radio.type = 'radio'; radio.id = `${q.id}_${value}`; radio.name = q.id; radio.value = value;
                            radio.className = 'h-4 w-4 themed-primary-text focus:ring-secondary-color border-gray-300';
                            if (q.required) radio.required = true;
                            const radioLabel = document.createElement('label');
                            radioLabel.htmlFor = `${q.id}_${value}`; radioLabel.textContent = labelText;
                            radioLabel.className = 'ml-1.5 text-sm themed-text';
                            radioDiv.appendChild(radio); radioDiv.appendChild(radioLabel);
                            ratingContainer.appendChild(radioDiv);
                        });
                    } else {
                        console.warn(`Question ${q.id} of type 'rating_1_5_custom_labels' is missing a valid 'labels' array.`);
                        // ... error display ...
                    }
                    questionDiv.appendChild(ratingContainer);
                } else if (q.type === 'yes_no') {
                    // ... yes/no rendering ...
                } else if (q.type === 'dropdown') {
                    // ... dropdown rendering (ensure this is for general questions, not the item select) ...
                }
                formContainer.appendChild(questionDiv);
            });
            submitButton.classList.remove('hidden');
        }

        submissionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!fullEventConfig || !fullEventConfig.testTypeConfig) {
                displayMessage("Cannot submit: Configuration error.", "error", messageArea); return;
            }

            const selectedItemId = itemSelect.value;
            let actualItemName = "";
            let isCustom = false;

            if (!selectedItemId) {
                displayMessage("Please select the item you are tasting.", "error", messageArea); return;
            }

            if (selectedItemId === "custom") {
                actualItemName = customItemNameInput.value.trim();
                if (!actualItemName) {
                    displayMessage("Please enter a name for your custom item.", "error", messageArea);
                    customItemNameInput.focus();
                    return;
                }
                isCustom = true;
            } else {
                const selectedItemObject = fullEventConfig.activeLocation.items.find(item => item.itemId === selectedItemId);
                actualItemName = selectedItemObject ? selectedItemObject.itemName : "Unknown Item";
            }


            showLoading(true);
            submitButton.disabled = true;
            const formData = new FormData(submissionForm); // This will get base question answers
            const answers = {};
            let allRequiredFilled = true;
            let firstMissingFieldLabel = "";

            // Validate base questions
            fullEventConfig.testTypeConfig.questions.forEach(q => {
                // ... (validation logic as before) ...
                const value = formData.get(q.id);
                answers[q.id] = value;
                if (q.required && (value === null || String(value).trim() === "")) {
                    allRequiredFilled = false;
                    if (!firstMissingFieldLabel) firstMissingFieldLabel = q.text;
                }
            });

            if (!allRequiredFilled) {
                displayMessage(`Please fill out all required rating fields. '${firstMissingFieldLabel}' is missing.`, "error", messageArea);
                showLoading(false); submitButton.disabled = false; return;
            }

            const submissionData = {
                eventId: fullEventConfig.eventId,
                locationId: fullEventConfig.activeLocation.locationId,
                locationName: fullEventConfig.activeLocation.locationName,
                itemId: isCustom ? "custom_" + Date.now() : selectedItemId, // Generate temp ID for custom
                itemName: actualItemName,
                isCustomItem: isCustom,
                testTypeId: fullEventConfig.testTypeConfig.id,
                answers: answers, // Answers to the base questions
                submittedAt: new Date().toISOString()
            };

            try {
                const response = await fetch(SUBMIT_FEEDBACK_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData),
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "Failed to submit feedback." }));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }
                const result = await response.json();
                displayMessage(result.message || "Thank you! Your feedback has been submitted.", "success", messageArea);
                submissionForm.reset(); // Resets base questions
                itemSelect.value = ""; // Reset item dropdown
                customItemEntry.classList.add('hidden'); // Hide custom input
                customItemNameInput.value = "";
                // Optionally go back to landing page
                // tasteTestSection.classList.add('hidden');
                // landingPageSection.classList.remove('hidden');
                // initializeLandingPage(); 
            } catch (error) {
                console.error("Error submitting feedback:", error);
                displayMessage(`Error submitting feedback: ${error.message}`, "error", messageArea);
            } finally {
                showLoading(false); submitButton.disabled = false;
            }
        });

        function showLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                landingPageSection.classList.add('opacity-50', 'pointer-events-none');
                tasteTestSection.classList.add('opacity-50', 'pointer-events-none');
            } else {
                loadingIndicator.classList.add('hidden');
                landingPageSection.classList.remove('opacity-50', 'pointer-events-none');
                tasteTestSection.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        function displayMessage(message, type = "info", targetElement = messageArea) {
            if (!targetElement) {
                targetElement = messageArea;
            }
            targetElement.textContent = message;
            targetElement.className = 'p-3 rounded-md text-sm mb-4 text-center';
            if (type === "success") targetElement.classList.add('bg-green-100', 'text-green-700');
            else if (type === "error") targetElement.classList.add('bg-red-100', 'text-red-700');
            else targetElement.classList.add('bg-blue-100', 'text-blue-700');
            targetElement.classList.remove('hidden');
            setTimeout(() => {
                targetElement.classList.add('hidden'); targetElement.textContent = '';
            }, 7000);
        }
        
        initializeLandingPage();
    </script>
    <!-- Trivial change for deployment test v3 -->
</body>
</html>
